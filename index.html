<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamHack - Capture, Decode & Collect Your Dreams</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Transform dreams into collectible insights with Jungian interpretation, archetype mapping, and gamified progress tracking. Your subconscious, tracked.">
    <meta property="og:title" content="DreamHack - Capture, Decode & Collect Your Dreams">
    <meta property="og:description" content="Transform dreams into collectible insights with Jungian interpretation, archetype mapping, and gamified progress tracking.">
    <meta property="og:type" content="website">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            borderRadius: {
              lg: "var(--radius)",
              md: "calc(var(--radius) - 2px)",
              sm: "calc(var(--radius) - 4px)",
            },
            colors: {
              background: "var(--background)",
              foreground: "var(--foreground)",
              card: {
                DEFAULT: "var(--card)",
                foreground: "var(--card-foreground)",
              },
              primary: {
                DEFAULT: "var(--primary)",
                foreground: "var(--primary-foreground)",
              },
              secondary: {
                DEFAULT: "var(--secondary)",
                foreground: "var(--secondary-foreground)",
              },
              muted: {
                DEFAULT: "var(--muted)",
                foreground: "var(--muted-foreground)",
              },
              accent: {
                DEFAULT: "var(--accent)",
                foreground: "var(--accent-foreground)",
              },
              destructive: {
                DEFAULT: "var(--destructive)",
                foreground: "var(--destructive-foreground)",
              },
              border: "var(--border)",
              input: "var(--input)",
              ring: "var(--ring)",
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            }
          },
        }
      };
    </script>
    
    <!-- Chart.js for Subconscious Map -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'
      import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js'
      import { getFirestore, collection, addDoc, query, where, orderBy, getDocs, doc, setDoc, getDoc, updateDoc, increment, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js'
      /* FIREBASE CONFIG - CONFIGURED */
      // Firebase configuration from your project console
      const firebaseConfig = {
        apiKey: "AIzaSyCyNrMLP5KKWAncich4G393k4hU_Du1PeI",
        authDomain: "dreambhai-2cd47.firebaseapp.com",
        projectId: "dreambhai-2cd47",
        storageBucket: "dreambhai-2cd47.firebasestorage.app",
        messagingSenderId: "639429346814",
        appId: "1:639429346814:web:6311b6127ba43064b92caf",
        measurementId: "G-TX370NT2Z0"
      };
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      
      // Make Firebase available globally
      window.auth = auth;
      window.db = db;
      window.firebaseAuth = { createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged };
      window.firestore = { collection, addDoc, query, where, orderBy, getDocs, doc, setDoc, getDoc, updateDoc, increment, writeBatch };
      // Set Gemini API key - configured
      window.GEMINI_API_KEY = 'AIzaSyBPfXUNrWWWJoOR42_5Kw21iIe5ju-l_Us';
    </script>
    <style>
      :root {
        --background: linear-gradient(135deg, hsl(220, 25%, 8%) 0%, hsl(225, 20%, 12%) 100%);
        --foreground: hsl(0, 0%, 98%);
        --card: rgba(255, 255, 255, 0.05);
        --card-foreground: hsl(0, 0%, 95%);
        --primary: hsl(210, 100%, 55%);
        --primary-foreground: hsl(0, 0%, 100%);
        --secondary: hsl(230, 15%, 20%);
        --secondary-foreground: hsl(0, 0%, 85%);
        --muted: hsl(230, 15%, 22%);
        --muted-foreground: hsl(0, 0%, 65%);
        --accent: hsl(25, 95%, 60%);
        --accent-foreground: hsl(0, 0%, 100%);
        --destructive: hsl(0, 84.2%, 60.2%);
        --destructive-foreground: hsl(0, 0%, 100%);
        --border: rgba(255, 255, 255, 0.1);
        --input: rgba(255, 255, 255, 0.05);
        --ring: hsl(210, 100%, 55%);
        --radius: 0.5rem;
        --glass-bg: rgba(255, 255, 255, 0.05);
        --glass-border: rgba(255, 255, 255, 0.1);
      }
      body {
        font-family: 'Inter', sans-serif;
        background: var(--background);
        color: var(--foreground);
        overflow-x: hidden;
      }
      .glass-card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }
      .clean-gradient {
        background: linear-gradient(135deg, hsl(210, 100%, 55%) 0%, hsl(250, 100%, 65%) 100%);
      }
      .badge-gradient {
        background: linear-gradient(135deg, hsl(250, 100%, 65%) 0%, hsl(280, 100%, 70%) 100%);
        border: 1px solid rgba(168, 85, 247, 0.3);
      }
      .floating-particles {
        position: absolute;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: -1;
      }
      .particle {
        position: absolute;
        background: radial-gradient(circle, rgba(59, 130, 246, 0.2) 0%, transparent 70%);
        border-radius: 50%;
        animation: float 8s ease-in-out infinite;
      }
      @keyframes float {
        0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.2; }
        50% { transform: translateY(-15px) rotate(180deg); opacity: 0.4; }
      }
      .dream-card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
      }
      .dream-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.4);
        border-color: rgba(59, 130, 246, 0.3);
      }
      .loading-spinner {
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top: 2px solid white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .slide-up {
        animation: slideUp 0.3s ease-out;
      }
      @keyframes slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .error-message {
        color: var(--destructive);
        background-color: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.2);
      }
      .success-message {
        color: hsl(120, 100%, 25%);
        background-color: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.2);
      }
      /* Modal styles */
      .modal-backdrop {
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
      }
      .modal-content {
        background: linear-gradient(145deg, hsl(225, 25%, 15%) 0%, hsl(230, 20%, 18%) 100%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      }
      .wellness-card {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
        border: 1px solid rgba(16, 185, 129, 0.2);
      }
      .wellness-warning {
        background: linear-gradient(135deg, rgba(245, 101, 101, 0.1) 0%, rgba(239, 68, 68, 0.1) 100%);
        border: 1px solid rgba(245, 101, 101, 0.2);
      }
      .wellness-neutral {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.1) 100%);
        border: 1px solid rgba(59, 130, 246, 0.2);
      }
    </style>
</head>
<body class="min-h-screen bg-background">
    <!-- Floating Particles Background -->
    <div class="floating-particles">
        <div class="particle" style="width: 3px; height: 3px; left: 10%; top: 20%; animation-delay: 0s;"></div>
        <div class="particle" style="width: 4px; height: 4px; left: 20%; top: 60%; animation-delay: 2s;"></div>
        <div class="particle" style="width: 2px; height: 2px; left: 60%; top: 30%; animation-delay: 4s;"></div>
        <div class="particle" style="width: 3px; height: 3px; left: 80%; top: 70%; animation-delay: 1s;"></div>
        <div class="particle" style="width: 3px; height: 3px; left: 30%; top: 80%; animation-delay: 3s;"></div>
        <div class="particle" style="width: 4px; height: 4px; left: 70%; top: 10%; animation-delay: 5s;"></div>
    </div>
    <!-- Navigation -->
    <nav class="glass-card border-0 shadow-lg relative z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 clean-gradient rounded-lg flex items-center justify-center shadow-lg">
                            <span class="text-white font-bold text-lg">D</span>
                        </div>
                        <span class="font-bold text-2xl bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">DreamHack</span>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div id="authButtons" class="flex items-center space-x-3">
                        <button id="loginBtn" data-testid="button-login" class="px-6 py-2 text-sm font-medium text-muted-foreground hover:text-white transition-all duration-200 rounded-lg hover:bg-white/10">
                            Sign In
                        </button>
                        <button id="signupBtn" data-testid="button-signup" class="px-6 py-2 clean-gradient text-white rounded-lg text-sm font-medium shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                            Sign Up
                        </button>
                    </div>
                    
                    <div id="userMenu" class="hidden flex items-center space-x-4">
                        <span id="userEmail" data-testid="text-user-email" class="text-sm text-muted-foreground"></span>
                        <button id="logoutBtn" data-testid="button-logout" class="px-4 py-2 text-sm font-medium text-muted-foreground hover:text-foreground transition-colors">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    <!-- Main App Container -->
    <div id="appContainer" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Landing/Welcome Section -->
        <div id="welcomeSection" class="text-center py-20">
            <h1 class="text-5xl sm:text-6xl lg:text-7xl font-bold mb-6 leading-tight">
                <span class="bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">
                    Capture, Decode &
                </span>
                <br>
                <span class="bg-gradient-to-r from-orange-400 via-red-400 to-pink-400 bg-clip-text text-transparent">
                    Collect Your Dreams
                </span>
            </h1>
            <p class="text-xl text-muted-foreground mb-10 max-w-3xl mx-auto leading-relaxed">
                <span class="text-white font-semibold">Your Subconscious, Tracked.</span> Transform dreams into collectible insights with AI-powered Jungian interpretation, archetype mapping, and gamified progress tracking.
            </p>
            <div class="flex flex-col sm:flex-row gap-6 justify-center items-center">
                <button id="getStartedBtn" data-testid="button-get-started" class="px-10 py-4 clean-gradient text-white rounded-xl font-semibold text-lg shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all duration-200">
                    Begin Your Journey
                </button>
                <p class="text-sm text-muted-foreground bg-black/20 px-4 py-2 rounded-lg backdrop-blur-sm border border-white/10">
                    🔒 Your dreams are private by default — share anonymized patterns only if you opt in.
                </p>
            </div>
        </div>
        <!-- Main Dashboard -->
        <div id="dashboardSection" class="hidden">
            <!-- Tab Navigation -->
            <div class="glass-card rounded-xl p-2 mb-8">
                <nav class="flex space-x-2">
                    <button data-tab="journal" data-testid="tab-journal" class="tab-btn flex-1 py-3 px-6 rounded-lg font-semibold transition-all duration-200 clean-gradient text-white shadow-lg">
                        📖 Dream Journal
                    </button>
                    <button data-tab="log" data-testid="tab-log" class="tab-btn flex-1 py-3 px-6 rounded-lg font-semibold transition-all duration-200 text-muted-foreground hover:text-white hover:bg-white/10">
                        ✨ Log Dream
                    </button>
                    <button data-tab="profile" data-testid="tab-profile" class="tab-btn flex-1 py-3 px-6 rounded-lg font-semibold transition-all duration-200 text-muted-foreground hover:text-white hover:bg-white/10">
                        👑 Profile
                    </button>
                </nav>
            </div>
            <!-- Dream Journal Tab -->
            <div id="journalTab" class="tab-content">
                <!-- Journal Controls -->
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <div class="flex items-center space-x-4">
                        <h2 class="text-2xl font-bold text-foreground">Dream Journal</h2>
                        <div class="flex bg-muted/50 rounded-lg p-1">
                            <button id="cardViewBtn" data-testid="button-card-view" class="px-3 py-1 rounded-md bg-white/10 text-white shadow-sm font-medium text-sm">
                                Cards
                            </button>
                            <button id="timelineViewBtn" data-testid="button-timeline-view" class="px-3 py-1 rounded-md text-muted-foreground font-medium text-sm hover:text-foreground transition-colors">
                                Timeline
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <input type="text" id="searchDreams" data-testid="input-search" placeholder="Search dreams, tags..." 
                                   class="pl-10 pr-4 py-2 glass-card rounded-lg text-white placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all duration-200">
                            <svg class="absolute left-3 top-2.5 h-5 w-5 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        
                        <select id="filterArchetype" data-testid="select-filter" class="px-3 py-2 glass-card rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all duration-200">
                            <option value="">All Archetypes</option>
                        </select>
                    </div>
                </div>
                <!-- Dreams Grid View -->
                <div id="dreamsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Dreams will be populated here -->
                </div>
                <!-- Dreams Timeline View -->
                <div id="dreamsTimeline" class="hidden space-y-6">
                    <!-- Timeline items will be populated here -->
                </div>
                <!-- Empty State -->
                <div id="emptyState" class="text-center py-16 hidden">
                    <div class="w-16 h-16 bg-muted/30 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2M4 13h2m13-8V4a1 1 0 00-1-1H7a1 1 0 00-1 1v1m8 0V4.5"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-foreground mb-2">No dreams yet</h3>
                    <p class="text-muted-foreground mb-4">Start your dream journey by logging your first dream.</p>
                    <button onclick="switchTab('log')" class="px-6 py-2 clean-gradient text-white rounded-lg font-medium hover:opacity-90 transition-opacity">
                        Log First Dream
                    </button>
                </div>
            </div>
            <!-- Log Dream Tab -->
            <div id="logTab" class="tab-content hidden">
                <div class="max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-foreground mb-6">Log New Dream</h2>
                    
                    <form id="dreamForm" class="space-y-6">
                        <div class="space-y-2">
                            <label for="dreamTitle" class="block text-sm font-semibold text-white mb-2 flex items-center space-x-2">
                                <span>💭</span>
                                <span>Dream Title</span>
                            </label>
                            <input type="text" id="dreamTitle" data-testid="input-dream-title" required
                                   class="w-full px-4 py-3 glass-card rounded-lg text-white placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all duration-200"
                                   placeholder="Give your dream a memorable title...">
                        </div>
                        
                        <div class="space-y-2">
                            <label for="dreamDescription" class="block text-sm font-semibold text-white mb-2 flex items-center space-x-2">
                                <span>📖</span>
                                <span>Dream Description</span>
                            </label>
                            <textarea id="dreamDescription" data-testid="input-dream-description" rows="8" required
                                      class="w-full px-4 py-3 glass-card rounded-lg text-white placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none transition-all duration-200"
                                      placeholder="Describe your dream in as much detail as you can remember..."></textarea>
                        </div>
                        
                        <button type="submit" id="submitDream" data-testid="button-analyze-dream" 
                                class="w-full py-4 clean-gradient text-white rounded-lg font-semibold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200 flex items-center justify-center space-x-3">
                            <span>✨ Get AI Dream Analysis</span>
                            <div id="dreamSpinner" class="loading-spinner hidden"></div>
                        </button>
                    </form>
                    
                    <!-- Dream Analysis Result -->
                    <div id="dreamAnalysis" class="hidden mt-8 space-y-6">
                        <!-- Jungian Analysis Section -->
                        <div class="glass-card p-6 rounded-lg">
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-500 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-xl font-bold bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">Jungian Analysis</h3>
                            </div>
                            <div id="analysisContent" class="space-y-4 text-gray-200">
                                <!-- Analysis content will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Real Life Insights Section -->
                        <div class="glass-card p-6 rounded-lg">
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-8 h-8 bg-gradient-to-r from-orange-500 to-pink-500 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-xl font-bold bg-gradient-to-r from-orange-400 to-pink-400 bg-clip-text text-transparent">Real Life Insights</h3>
                            </div>
                            <div id="insightsContent" class="space-y-4 text-gray-200">
                                <!-- Insights content will be populated here -->
                            </div>
                        </div>
                        
                        <button id="saveDreamBtn" data-testid="button-save-dream" class="w-full py-4 clean-gradient text-white rounded-lg font-semibold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                            Save to Dream Journal
                        </button>
                    </div>
                    <!-- Error Message -->
                    <div id="analysisError" class="hidden mt-4 p-3 error-message rounded-lg">
                        <p class="text-sm"></p>
                    </div>
                </div>
            </div>
            <!-- Profile Tab -->
            <div id="profileTab" class="tab-content hidden">
                <div class="max-w-6xl mx-auto">
                    <h2 class="text-2xl font-bold text-foreground mb-8">Profile Dashboard</h2>
                    
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="glass-card rounded-lg p-6 text-center">
                            <div class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent mb-2" data-testid="stat-total-dreams" data-bind="user.totalDreams">0</div>
                            <div class="text-sm text-gray-300">💭 Total Dreams</div>
                        </div>
                        
                        <div class="glass-card rounded-lg p-6 text-center">
                            <div class="text-3xl font-bold bg-gradient-to-r from-orange-400 to-pink-400 bg-clip-text text-transparent mb-2" data-testid="stat-current-streak" data-bind="user.currentStreak">0</div>
                            <div class="text-sm text-gray-300">🔥 Current Streak</div>
                        </div>
                        
                        <div class="glass-card rounded-lg p-6 text-center">
                            <div class="text-3xl font-bold bg-gradient-to-r from-green-400 to-blue-400 bg-clip-text text-transparent mb-2" data-testid="stat-total-tokens" data-bind="user.totalTokens">0</div>
                            <div class="text-sm text-gray-300">⭐ Total Tokens</div>
                        </div>
                        
                        <div class="glass-card rounded-lg p-6 text-center">
                            <div class="text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent mb-2" data-testid="stat-badge-count" data-bind="user.badgeCount">0</div>
                            <div class="text-sm text-gray-300">🏆 Badges Earned</div>
                        </div>
                    </div>
                    <!-- Mental Wellness Section -->
                    <div class="mb-8">
                        <div class="glass-card rounded-lg p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl font-bold bg-gradient-to-r from-green-400 to-blue-400 bg-clip-text text-transparent flex items-center space-x-2">
                                    <span>🧠</span>
                                    <span>Mental Wellness Analysis</span>
                                </h3>
                                <button id="analyzeWellnessBtn" data-testid="button-analyze-wellness" class="px-4 py-2 clean-gradient text-white rounded-lg text-sm font-medium hover:opacity-90 transition-opacity">
                                    Analyze Trends
                                </button>
                            </div>
                            
                            <div id="wellnessContent" class="space-y-4">
                                <div class="text-gray-400 text-center py-8">
                                    <p>Click "Analyze Trends" to get insights about your mental wellness based on your recent dream patterns.</p>
                                    <p class="text-sm mt-2">Requires at least 3 dreams for analysis.</p>
                                </div>
                            </div>
                            
                            <div id="wellnessSpinner" class="hidden text-center py-8">
                                <div class="loading-spinner mx-auto mb-4"></div>
                                <p class="text-gray-400">Analyzing your dream patterns...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Badges Section -->
                    <div class="glass-card rounded-lg p-6 mb-8">
                        <h3 class="text-xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent mb-4 flex items-center space-x-2">
                            <span>🏆</span>
                            <span>Archetype Badges</span>
                        </h3>
                        <div id="badgesList" class="flex flex-wrap gap-3">
                            <div class="text-gray-400 text-sm">No badges earned yet. Start logging dreams to discover your archetypes!</div>
                        </div>
                    </div>
                    
                    <!-- Subconscious Map -->
                    <div class="glass-card rounded-lg p-6">
                        <h3 class="text-xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent mb-4 flex items-center space-x-2">
                            <span>🧠</span>
                            <span>Subconscious Map</span>
                        </h3>
                        <div id="themesChart" class="space-y-3">
                            <!-- Theme bars will be populated here -->
                        </div>
                        <div id="noThemes" class="text-gray-400 text-sm">
                            Log more dreams to see your recurring themes and patterns.
                        </div>
                        
                        <!-- Privacy Toggle -->
                        <div class="mt-6 pt-4 border-t border-gray-700">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" id="shareToggle" data-testid="toggle-share" class="w-4 h-4 text-primary bg-gray-700 border-gray-600 rounded focus:ring-primary focus:ring-2">
                                <span class="text-sm text-gray-300">
                                    Share anonymized pattern data to help improve insights
                                </span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Authentication Modals -->
    <!-- Sign Up Modal -->
    <div id="signupModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="modal-backdrop fixed inset-0" onclick="closeModal('signupModal')"></div>
            <div class="modal-content relative max-w-md w-full mx-auto rounded-xl p-8">
                <button onclick="closeModal('signupModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                
                <div class="text-center mb-8">
                    <div class="w-12 h-12 clean-gradient rounded-lg flex items-center justify-center mx-auto mb-4">
                        <span class="text-white font-bold text-xl">D</span>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-2">Create Your Account</h2>
                    <p class="text-gray-400">Start your dream tracking journey</p>
                </div>
                <form id="signupForm" class="space-y-4">
                    <div>
                        <label for="signupEmail" class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                        <input type="email" id="signupEmail" data-testid="input-signup-email" required
                               class="w-full px-4 py-3 glass-card rounded-lg text-white placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all duration-200"
                               placeholder="Enter your email">
                    </div>
                    <div>
                        <label for="signupPassword" class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                        <input type="password" id="signupPassword" data-testid="input-signup-password" required
                               class="w-full px-4 py-3 glass-card rounded-lg text-white placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all duration-200"
                               placeholder="Choose a strong password">
                    </div>
                    
                    <button type="submit" data-testid="button-create-account" 
                            class="w-full py-3 clean-gradient text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all duration-200">
                        Create Account
                    </button>
                </form>
                
                <div class="mt-6 text-center">
                    <p class="text-gray-400 text-sm">Already have an account? 
                        <button onclick="switchModal('signupModal', 'loginModal')" class="text-blue-400 hover:text-blue-300 font-medium">Sign in</button>
                    </p>
                </div>
                <div id="signupError" class="hidden mt-4 p-3 error-message rounded-lg">
                    <p class="text-sm"></p>
                </div>
            </div>
        </div>
    </div>
    <!-- Login Modal -->
    <div id="loginModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="modal-backdrop fixed inset-0" onclick="closeModal('loginModal')"></div>
            <div class="modal-content relative max-w-md w-full mx-auto rounded-xl p-8">
                <button onclick="closeModal('loginModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                
                <div class="text-center mb-8">
                    <div class="w-12 h-12 clean-gradient rounded-lg flex items-center justify-center mx-auto mb-4">
                        <span class="text-white font-bold text-xl">D</span>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-2">Welcome Back</h2>
                    <p class="text-gray-400">Sign in to continue your journey</p>
                </div>
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label for="loginEmail" class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                        <input type="email" id="loginEmail" data-testid="input-login-email" required
                               class="w-full px-4 py-3 glass-card rounded-lg text-white placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all duration-200"
                               placeholder="Enter your email">
                    </div>
                    <div>
                        <label for="loginPassword" class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                        <input type="password" id="loginPassword" data-testid="input-login-password" required
                               class="w-full px-4 py-3 glass-card rounded-lg text-white placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all duration-200"
                               placeholder="Enter your password">
                    </div>
                    
                    <button type="submit" data-testid="button-sign-in" 
                            class="w-full py-3 clean-gradient text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all duration-200">
                        Sign In
                    </button>
                </form>
                
                <div class="mt-6 text-center">
                    <p class="text-gray-400 text-sm">Don't have an account? 
                        <button onclick="switchModal('loginModal', 'signupModal')" class="text-blue-400 hover:text-blue-300 font-medium">Sign up</button>
                    </p>
                </div>
                <div id="loginError" class="hidden mt-4 p-3 error-message rounded-lg">
                    <p class="text-sm"></p>
                </div>
            </div>
        </div>
    </div>
    <!-- Success Toast -->
    <div id="successToast" class="fixed top-4 right-4 z-50 success-message p-4 rounded-lg shadow-lg transform translate-x-full opacity-0 transition-all duration-300">
        <div class="flex items-center space-x-2">
            <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
            <span id="successMessage" class="font-medium"></span>
        </div>
    </div>
    <!-- Onboarding Modal -->
    <div id="onboardingModal" class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="modal-backdrop fixed inset-0"></div>
            <div class="modal-content relative max-w-lg w-full mx-auto rounded-xl p-8 text-center">
                <div class="w-16 h-16 clean-gradient rounded-full flex items-center justify-center mx-auto mb-6">
                    <span class="text-white font-bold text-2xl">D</span>
                </div>
                
                <h2 class="text-3xl font-bold text-white mb-4">Welcome to DreamHack!</h2>
                <p class="text-gray-300 mb-6 leading-relaxed">
                    Your personal dream analysis companion. Track patterns, discover insights, and explore your subconscious mind with AI-powered interpretation.
                </p>
                
                <div class="space-y-3 text-left mb-8">
                    <div class="flex items-center space-x-3 text-gray-300">
                        <span class="text-blue-400">✨</span>
                        <span>Log and analyze dreams with AI</span>
                    </div>
                    <div class="flex items-center space-x-3 text-gray-300">
                        <span class="text-purple-400">🏆</span>
                        <span>Earn badges for recurring archetypes</span>
                    </div>
                    <div class="flex items-center space-x-3 text-gray-300">
                        <span class="text-green-400">🧠</span>
                        <span>Track patterns and mental wellness</span>
                    </div>
                    <div class="flex items-center space-x-3 text-gray-300">
                        <span class="text-orange-400">🔒</span>
                        <span>Private by default, secure storage</span>
                    </div>
                </div>
                
                <button onclick="closeOnboarding()" data-testid="button-got-it" 
                        class="w-full py-3 clean-gradient text-white rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all duration-200">
                    Got it!
                </button>
            </div>
        </div>
    </div>
    <script>
        // Global state
        let currentUser = null;
        let userProfile = null;
        let dreams = [];
        let currentView = 'cards';
        // Initialize app
        window.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        function initializeApp() {
            // Set up auth state listener
            window.firebaseAuth.onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    showDashboard();
                    loadUserData();
                } else {
                    currentUser = null;
                    showWelcome();
                }
            });
            // Set up event listeners
            setupEventListeners();
            
            // Initialize UI
            updateAuthUI();
        }
        function setupEventListeners() {
            // Authentication
            document.getElementById('signupBtn').addEventListener('click', () => openModal('signupModal'));
            document.getElementById('loginBtn').addEventListener('click', () => openModal('loginModal'));
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('getStartedBtn').addEventListener('click', () => openModal('signupModal'));
            document.getElementById('signupForm').addEventListener('submit', handleSignup);
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            // Dream form
            document.getElementById('dreamForm').addEventListener('submit', handleDreamSubmit);
            document.getElementById('saveDreamBtn').addEventListener('click', saveDreamToFirestore);
            // Wellness analysis
            document.getElementById('analyzeWellnessBtn').addEventListener('click', analyzeWellness);
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => switchTab(e.target.dataset.tab));
            });
            // View switching
            document.getElementById('cardViewBtn').addEventListener('click', () => switchView('cards'));
            document.getElementById('timelineViewBtn').addEventListener('click', () => switchView('timeline'));
            // Search and filter
            document.getElementById('searchDreams').addEventListener('input', filterDreams);
            document.getElementById('filterArchetype').addEventListener('change', filterDreams);
            // Privacy toggle
            document.getElementById('shareToggle').addEventListener('change', handlePrivacyToggle);
        }
        // Authentication functions
        async function handleSignup(e) {
            e.preventDefault();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            if (password.length < 6) {
                showError('signupError', 'Password must be at least 6 characters long.');
                return;
            }
            try {
                await window.firebaseAuth.createUserWithEmailAndPassword(auth, email, password);
                closeModal('signupModal');
                showSuccessToast('Account created successfully!');
            } catch (error) {
                console.error('Signup error:', error);
                showError('signupError', getAuthErrorMessage(error.code));
            }
        }
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            try {
                await window.firebaseAuth.signInWithEmailAndPassword(auth, email, password);
                closeModal('loginModal');
                showSuccessToast('Welcome back!');
            } catch (error) {
                console.error('Login error:', error);
                showError('loginError', getAuthErrorMessage(error.code));
            }
        }
        async function handleLogout() {
            try {
                await window.firebaseAuth.signOut(auth);
                showSuccessToast('Logged out successfully');
            } catch (error) {
                console.error('Logout error:', error);
            }
        }
        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.body.style.overflow = 'auto';
            
            // Clear form errors
            const errorEl = document.querySelector(`#${modalId} .error-message`);
            if (errorEl) errorEl.classList.add('hidden');
        }
        function switchModal(fromModal, toModal) {
            closeModal(fromModal);
            openModal(toModal);
        }
        function closeOnboarding() {
            closeModal('onboardingModal');
            localStorage.setItem('hasSeenOnboarding', 'true');
        }
        // UI state functions
        function showWelcome() {
            document.getElementById('welcomeSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            updateAuthUI();
            
            // Show onboarding for new users
            if (!localStorage.getItem('hasSeenOnboarding')) {
                setTimeout(() => openModal('onboardingModal'), 1000);
            }
        }
        function showDashboard() {
            document.getElementById('welcomeSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            updateAuthUI();
            closeModal('onboardingModal');
        }
        function updateAuthUI() {
            const authButtons = document.getElementById('authButtons');
            const userMenu = document.getElementById('userMenu');
            const userEmail = document.getElementById('userEmail');
            if (currentUser) {
                authButtons.classList.add('hidden');
                userMenu.classList.remove('hidden');
                userEmail.textContent = currentUser.email;
            } else {
                authButtons.classList.remove('hidden');
                userMenu.classList.add('hidden');
            }
        }
        // Tab switching
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (btn.dataset.tab === tab) {
                    btn.classList.remove('text-muted-foreground', 'hover:text-white', 'hover:bg-white/10');
                    btn.classList.add('clean-gradient', 'text-white', 'shadow-lg');
                } else {
                    btn.classList.add('text-muted-foreground', 'hover:text-white', 'hover:bg-white/10');
                    btn.classList.remove('clean-gradient', 'text-white', 'shadow-lg');
                }
            });
            // Show/hide tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tab + 'Tab').classList.remove('hidden');
            // Load data if switching to journal
            if (tab === 'journal') {
                renderDreams();
            }
        }
        // View switching
        function switchView(view) {
            currentView = view;
            
            if (view === 'cards') {
                document.getElementById('cardViewBtn').classList.add('bg-white/10', 'text-white', 'shadow-sm');
                document.getElementById('cardViewBtn').classList.remove('text-muted-foreground');
                document.getElementById('timelineViewBtn').classList.remove('bg-white/10', 'text-white', 'shadow-sm');
                document.getElementById('timelineViewBtn').classList.add('text-muted-foreground');
                
                document.getElementById('dreamsGrid').classList.remove('hidden');
                document.getElementById('dreamsTimeline').classList.add('hidden');
            } else {
                document.getElementById('timelineViewBtn').classList.add('bg-white/10', 'text-white', 'shadow-sm');
                document.getElementById('timelineViewBtn').classList.remove('text-muted-foreground');
                document.getElementById('cardViewBtn').classList.remove('bg-white/10', 'text-white', 'shadow-sm');
                document.getElementById('cardViewBtn').classList.add('text-muted-foreground');
                
                document.getElementById('dreamsGrid').classList.add('hidden');
                document.getElementById('dreamsTimeline').classList.remove('hidden');
            }
        }
        async function handleDreamSubmit(e) {
            e.preventDefault();
            const title = document.getElementById('dreamTitle').value.trim();
            const description = document.getElementById('dreamDescription').value.trim();
            if (!title || !description) {
                showError('analysisError', 'Please fill in both title and description.');
                return;
            }
            // Show loading
            document.getElementById('dreamSpinner').classList.remove('hidden');
            document.getElementById('submitDream').disabled = true;
            document.getElementById('analysisError').classList.add('hidden');
            try {
                const geminiApiKey = window.GEMINI_API_KEY;
                const interpretation = await callGeminiAPI(title, description, geminiApiKey);
                displayDreamAnalysis(title, description, interpretation);
            } catch (error) {
                console.error('Analysis error:', error);
                showError('analysisError', 'Failed to analyze dream. Please check your connection and try again.');
            } finally {
                document.getElementById('dreamSpinner').classList.add('hidden');
                document.getElementById('submitDream').disabled = false;
            }
        }
        async function callGeminiAPI(title, description, apiKey) {
            if (!apiKey || apiKey === 'YOUR_GEMINI_API_KEY_HERE') {
                throw new Error('Gemini API key not configured.');
            }
            const prompt = `Analyze the following dream from both psychological and practical perspectives:
Title: ${title}
Description: ${description}
Please provide:
1. A detailed Jungian interpretation focusing on archetypes, symbols, and unconscious meanings (2-3 sentences)
2. Real life insights with practical lessons and actionable advice for the dreamer's waking life (2-3 sentences)
3. A list of 3-5 archetypal symbols or themes found in the dream
Return the response as JSON in this exact format:
{
  "interpretation": "Your detailed Jungian interpretation here...",
  "insights": "Practical real-life insights and actionable advice here...",
  "tags": ["archetype1", "archetype2", "symbol1", "theme1", "symbol2"]
}`;
            const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=' + apiKey, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        temperature: 0.7,
                        topK: 1,
                        topP: 1,
                        maxOutputTokens: 2048,
                    }
                })
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Gemini API error: ${errorData.error?.message || 'Unknown error'}`);
            }
            const data = await response.json();
            const generatedText = data.candidates[0].content.parts[0].text;
            
            try {
                const jsonMatch = generatedText.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const parsed = JSON.parse(jsonMatch[0]);
                    if (!parsed.insights) {
                        parsed.insights = 'Consider reflecting on the emotions and themes in your dream for personal growth opportunities.';
                    }
                    return parsed;
                }
            } catch (parseError) {
                console.warn('Could not parse JSON from Gemini response');
            }
            
            return {
                interpretation: generatedText.split('\n')[0] || 'Unable to generate interpretation',
                insights: 'Consider reflecting on the emotions and themes in your dream for personal growth opportunities.',
                tags: ['unconscious', 'symbols', 'archetype', 'meaning']
            };
        }
        function displayDreamAnalysis(title, description, analysis) {
            const analysisContent = document.getElementById('analysisContent');
            const insightsContent = document.getElementById('insightsContent');
            
            analysisContent.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-black/20 rounded-lg p-4 border border-white/10">
                        <p class="text-gray-200 leading-relaxed">${escapeHtml(analysis.interpretation)}</p>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-white mb-3 flex items-center space-x-2">
                            <span>🏷️</span>
                            <span>Archetypes & Themes:</span>
                        </h4>
                        <div class="flex flex-wrap gap-2">
                            ${analysis.tags.map(tag => `
                                <span class="px-3 py-1 badge-gradient text-purple-200 rounded-full text-sm font-medium shadow-lg">${escapeHtml(tag)}</span>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            insightsContent.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-black/20 rounded-lg p-4 border border-white/10">
                        <p class="text-gray-200 leading-relaxed">${escapeHtml(analysis.insights || 'Consider reflecting on the emotions and themes in your dream for personal growth opportunities.')}</p>
                    </div>
                    
                    <div class="bg-gradient-to-r from-orange-500/10 to-pink-500/10 rounded-lg p-4 border border-orange-400/30">
                        <h4 class="font-semibold text-orange-300 mb-2 flex items-center space-x-2">
                            <span>🌱</span>
                            <span>Growth Opportunity</span>
                        </h4>
                        <p class="text-orange-200 text-sm">Reflect on these insights during quiet moments today. Consider journaling about the emotions and symbols that stood out to you.</p>
                    </div>
                </div>
            `;
            
            window.currentDreamAnalysis = { title, description, analysis };
            document.getElementById('dreamAnalysis').classList.remove('hidden');
        }
        // Mental Wellness Analysis
        async function analyzeWellness() {
            if (dreams.length < 3) {
                showError('analysisError', 'You need at least 3 dreams for wellness analysis.');
                return;
            }
            const wellnessSpinner = document.getElementById('wellnessSpinner');
            const wellnessContent = document.getElementById('wellnessContent');
            const analyzeBtn = document.getElementById('analyzeWellnessBtn');
            
            wellnessSpinner.classList.remove('hidden');
            wellnessContent.classList.add('hidden');
            analyzeBtn.disabled = true;
            try {
                const geminiApiKey = window.GEMINI_API_KEY;
                const recentDreams = dreams.slice(0, 5); // Last 5 dreams
                
                const dreamSummaries = recentDreams.map(dream => 
                    `Dream: "${dream.title}" - ${dream.description.substring(0, 200)}... Interpretation: ${dream.interpretation.substring(0, 200)}...`
                ).join('\n\n');
                const wellnessPrompt = `Analyze the following dreams and their interpretations to provide a mental wellness assessment:
${dreamSummaries}
Please provide a mental wellness analysis focusing on:
1. Overall psychological patterns and themes
2. Emotional state indicators
3. Stress or anxiety signals
4. Positive mental health indicators
5. Practical recommendations for mental wellness
Return the response as JSON in this exact format:
{
  "overall_state": "positive/neutral/concerning",
  "summary": "Brief 2-3 sentence summary of mental state",
  "key_patterns": ["pattern1", "pattern2", "pattern3"],
  "recommendations": ["recommendation1", "recommendation2", "recommendation3"],
  "wellness_score": 75
}`;
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=' + geminiApiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: wellnessPrompt }] }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 1,
                            topP: 1,
                            maxOutputTokens: 2048,
                        }
                    })
                });
                if (!response.ok) throw new Error('Failed to analyze wellness');
                const data = await response.json();
                const generatedText = data.candidates[0].content.parts[0].text;
                
                let wellnessData;
                try {
                    const jsonMatch = generatedText.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        wellnessData = JSON.parse(jsonMatch[0]);
                    }
                } catch (parseError) {
                    throw new Error('Unable to parse wellness analysis');
                }
                displayWellnessAnalysis(wellnessData);
                
            } catch (error) {
                console.error('Wellness analysis error:', error);
                wellnessContent.innerHTML = `
                    <div class="text-red-400 text-center py-8">
                        <p>Unable to analyze wellness patterns. Please try again later.</p>
                    </div>
                `;
                wellnessContent.classList.remove('hidden');
            } finally {
                wellnessSpinner.classList.add('hidden');
                analyzeBtn.disabled = false;
            }
        }
        function displayWellnessAnalysis(data) {
            const wellnessContent = document.getElementById('wellnessContent');
            
            let cardClass, iconColor, stateIcon;
            switch(data.overall_state) {
                case 'positive':
                    cardClass = 'wellness-card';
                    iconColor = 'text-green-400';
                    stateIcon = '😊';
                    break;
                case 'concerning':
                    cardClass = 'wellness-warning';
                    iconColor = 'text-red-400';
                    stateIcon = '😰';
                    break;
                default:
                    cardClass = 'wellness-neutral';
                    iconColor = 'text-blue-400';
                    stateIcon = '😐';
            }
            wellnessContent.innerHTML = `
                <div class="${cardClass} rounded-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">${stateIcon}</span>
                            <div>
                                <h4 class="font-bold ${iconColor}">Mental Wellness Score</h4>
                                <p class="text-sm text-gray-300">Based on your last ${Math.min(dreams.length, 5)} dreams</p>
                            </div>
                        </div>
                        <div class="text-3xl font-bold ${iconColor}">${data.wellness_score || 'N/A'}</div>
                    </div>
                    
                    <p class="text-gray-200 mb-6 leading-relaxed">${escapeHtml(data.summary || 'Unable to generate summary')}</p>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <h5 class="font-semibold text-white mb-3 flex items-center space-x-2">
                                <span>🔍</span>
                                <span>Key Patterns</span>
                            </h5>
                            <ul class="space-y-2">
                                ${(data.key_patterns || ['No patterns identified']).map(pattern => `
                                    <li class="text-gray-300 text-sm flex items-start space-x-2">
                                        <span class="text-blue-400 mt-1">•</span>
                                        <span>${escapeHtml(pattern)}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        
                        <div>
                            <h5 class="font-semibold text-white mb-3 flex items-center space-x-2">
                                <span>💡</span>
                                <span>Recommendations</span>
                            </h5>
                            <ul class="space-y-2">
                                ${(data.recommendations || ['Consider keeping a regular sleep schedule']).map(rec => `
                                    <li class="text-gray-300 text-sm flex items-start space-x-2">
                                        <span class="text-green-400 mt-1">•</span>
                                        <span>${escapeHtml(rec)}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-gray-600">
                        <p class="text-gray-400 text-xs text-center">
                            This analysis is for informational purposes only. For professional mental health support, consult a qualified therapist.
                        </p>
                    </div>
                </div>
            `;
            
            wellnessContent.classList.remove('hidden');
        }
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        async function saveDreamToFirestore() {
            if (!currentUser || !window.currentDreamAnalysis) return;
            try {
                const dreamData = {
                    userId: currentUser.uid,
                    title: window.currentDreamAnalysis.title,
                    description: window.currentDreamAnalysis.description,
                    interpretation: window.currentDreamAnalysis.analysis.interpretation,
                    tags: window.currentDreamAnalysis.analysis.tags,
                    dateCreated: new Date(),
                    tokensEarned: 5
                };
                await window.firestore.addDoc(window.firestore.collection(db, `users/${currentUser.uid}/dreams`), dreamData);
                await updateUserStats(dreamData.tokensEarned, dreamData.tags);
                document.getElementById('dreamForm').reset();
                document.getElementById('dreamAnalysis').classList.add('hidden');
                window.currentDreamAnalysis = null;
                switchTab('journal');
                await loadUserData();
                
                showSuccessToast('Dream saved successfully!');
            } catch (error) {
                console.error('Error saving dream:', error);
                showError('analysisError', 'Failed to save dream. Please try again.');
            }
        }
        async function updateUserStats(tokensEarned, tags) {
            if (!currentUser) return;
            try {
                const userRef = window.firestore.doc(db, 'users', currentUser.uid);
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                const userDoc = await window.firestore.getDoc(userRef);
                const userData = userDoc.data();
                
                let newStreak = 1;
                if (userData.lastDreamDate) {
                    const lastDate = userData.lastDreamDate.toDate();
                    const lastDateOnly = new Date(lastDate.getFullYear(), lastDate.getMonth(), lastDate.getDate());
                    const dayDiff = Math.floor((today - lastDateOnly) / (1000 * 60 * 60 * 24));
                    
                    if (dayDiff === 0) {
                        newStreak = userData.currentStreak || 1;
                    } else if (dayDiff === 1) {
                        newStreak = (userData.currentStreak || 0) + 1;
                    } else {
                        newStreak = 1;
                    }
                }
                await window.firestore.updateDoc(userRef, {
                    totalTokens: window.firestore.increment(tokensEarned),
                    currentStreak: newStreak,
                    lastDreamDate: now
                });
                await updateBadges(userRef, tags);
                if (userData.shareAnonymized) {
                    await updateGlobalTagCounts(tags);
                }
            } catch (error) {
                console.error('Error updating user stats:', error);
            }
        }
        async function updateBadges(userRef, dreamTags) {
            try {
                const userDoc = await window.firestore.getDoc(userRef);
                const userData = userDoc.data();
                const currentBadges = userData.badges || [];
                const tagCounts = {};
                dreams.forEach(dream => {
                    dream.tags?.forEach(tag => {
                        tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                    });
                });
                dreamTags.forEach(tag => {
                    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                });
                const newBadges = [...currentBadges];
                const badgeThreshold = 3;
                Object.entries(tagCounts).forEach(([tag, count]) => {
                    if (count >= badgeThreshold && !currentBadges.includes(tag)) {
                        newBadges.push(tag);
                    }
                });
                if (newBadges.length > currentBadges.length) {
                    await window.firestore.updateDoc(userRef, {
                        badges: newBadges
                    });
                    
                    const newBadgeNames = newBadges.filter(b => !currentBadges.includes(b));
                    showSuccessToast(`New badge unlocked: ${newBadgeNames.join(', ')}!`);
                }
            } catch (error) {
                console.error('Error updating badges:', error);
            }
        }
        async function updateGlobalTagCounts(tags) {
            try {
                const batch = window.firestore.writeBatch(db);
                
                tags.forEach(tag => {
                    const tagRef = window.firestore.doc(db, 'globalTagCounts', tag);
                    batch.set(tagRef, {
                        count: window.firestore.increment(1)
                    }, { merge: true });
                });
                await batch.commit();
            } catch (error) {
                console.error('Error updating global tag counts:', error);
            }
        }
        async function loadUserData() {
            if (!currentUser) return;
            try {
                const userDoc = await window.firestore.getDoc(window.firestore.doc(db, 'users', currentUser.uid));
                if (userDoc.exists()) {
                    userProfile = userDoc.data();
                } else {
                    userProfile = {
                        email: currentUser.email,
                        streakCount: 0,
                        currentStreak: 0,
                        totalTokens: 0,
                        badges: [],
                        shareAnonymized: false,
                        createdAt: new Date(),
                        lastDreamDate: null
                    };
                    await window.firestore.setDoc(window.firestore.doc(db, 'users', currentUser.uid), userProfile);
                }
                const dreamsQuery = window.firestore.query(
                    window.firestore.collection(db, `users/${currentUser.uid}/dreams`),
                    window.firestore.orderBy('dateCreated', 'desc')
                );
                const dreamSnapshot = await window.firestore.getDocs(dreamsQuery);
                dreams = dreamSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateDashboardStats();
                renderDreams();
                updateSubconsciousMap();
                populateArchetypeFilter();
            } catch (error) {
                console.error('Error loading user data:', error);
                showError('general', 'Failed to load your data. Please refresh the page.');
            }
        }
        function updateDashboardStats() {
            if (!userProfile) return;
            const totalDreamsEl = document.querySelector('[data-bind="user.totalDreams"]');
            const currentStreakEl = document.querySelector('[data-bind="user.currentStreak"]');
            const totalTokensEl = document.querySelector('[data-bind="user.totalTokens"]');
            const badgeCountEl = document.querySelector('[data-bind="user.badgeCount"]');
            if (totalDreamsEl) totalDreamsEl.textContent = dreams.length;
            if (currentStreakEl) currentStreakEl.textContent = userProfile.currentStreak || 0;
            if (totalTokensEl) totalTokensEl.textContent = userProfile.totalTokens || 0;
            if (badgeCountEl) badgeCountEl.textContent = (userProfile.badges || []).length;
            // Update badges display
            const badgesList = document.getElementById('badgesList');
            const badges = userProfile.badges || [];
            
            if (badges.length === 0) {
                badgesList.innerHTML = '<div class="text-gray-400 text-sm">No badges earned yet. Start logging dreams to discover your archetypes!</div>';
            } else {
                badgesList.innerHTML = badges.map(badge => `
                    <span class="px-3 py-2 badge-gradient text-purple-200 rounded-full text-sm font-medium shadow-lg capitalize">
                        🏆 ${escapeHtml(badge)}
                    </span>
                `).join('');
            }
        }
        function renderDreams() {
            const gridContainer = document.getElementById('dreamsGrid');
            const timelineContainer = document.getElementById('dreamsTimeline');
            const emptyState = document.getElementById('emptyState');
            if (dreams.length === 0) {
                gridContainer.innerHTML = '';
                timelineContainer.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');
            gridContainer.innerHTML = dreams.map(dream => createDreamCard(dream)).join('');
            timelineContainer.innerHTML = dreams.map(dream => createTimelineItem(dream)).join('');
        }
        function createDreamCard(dream) {
            const date = dream.dateCreated?.toDate ? dream.dateCreated.toDate() : new Date(dream.dateCreated);
            const relativeDate = getRelativeDate(date);
            
            return `
                <div class="dream-card glass-card rounded-lg p-6 cursor-pointer" data-testid="card-dream-${dream.id}">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-semibold text-white text-lg">${escapeHtml(dream.title)}</h3>
                        <span class="text-xs text-gray-400">${relativeDate}</span>
                    </div>
                    
                    <p class="text-gray-300 text-sm mb-4 line-clamp-3">
                        ${escapeHtml(dream.description)}
                    </p>
                    
                    <div class="mb-4">
                        <h4 class="text-sm font-medium text-white mb-2">Jungian Interpretation:</h4>
                        <p class="text-xs text-gray-300 line-clamp-2">
                            ${escapeHtml(dream.interpretation)}
                        </p>
                    </div>
                    
                    <div class="flex flex-wrap gap-2 mb-4">
                        ${(dream.tags || []).map(tag => `
                            <span class="px-2 py-1 badge-gradient text-purple-200 rounded-full text-xs font-medium">${escapeHtml(tag)}</span>
                        `).join('')}
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-400">Tokens Earned: ${dream.tokensEarned || 0}</span>
                        <div class="flex items-center space-x-1">
                            <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.719c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                            </svg>
                            <span class="text-xs font-medium text-yellow-400">+${dream.tokensEarned || 0}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        function createTimelineItem(dream) {
            const date = dream.dateCreated?.toDate ? dream.dateCreated.toDate() : new Date(dream.dateCreated);
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthAbbr = monthNames[date.getMonth()];
            
            return `
                <div class="flex space-x-4" data-testid="timeline-dream-${dream.id}">
                    <div class="flex-shrink-0 w-10 h-10 clean-gradient rounded-full flex items-center justify-center">
                        <span class="text-white text-sm font-medium">${monthAbbr}</span>
                    </div>
                    <div class="flex-1 glass-card rounded-lg p-6">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-semibold text-white">${escapeHtml(dream.title)}</h3>
                            <span class="text-xs text-gray-400">${date.toLocaleDateString()}</span>
                        </div>
                        <p class="text-gray-300 text-sm mb-3">
                            ${escapeHtml(dream.description)}
                        </p>
                        <div class="flex flex-wrap gap-2">
                            ${(dream.tags || []).map(tag => `
                                <span class="px-2 py-1 badge-gradient text-purple-200 rounded-full text-xs">${escapeHtml(tag)}</span>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        function getRelativeDate(date) {
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
            return date.toLocaleDateString();
        }
        function updateSubconsciousMap() {
            const tagCounts = {};
            dreams.forEach(dream => {
                dream.tags?.forEach(tag => {
                    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                });
            });
            const sortedTags = Object.entries(tagCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            const themesChart = document.getElementById('themesChart');
            const noThemes = document.getElementById('noThemes');
            
            if (sortedTags.length === 0) {
                themesChart.innerHTML = '';
                noThemes.classList.remove('hidden');
            } else {
                noThemes.classList.add('hidden');
                const maxCount = Math.max(...sortedTags.map(([,count]) => count));
                
                themesChart.innerHTML = sortedTags.map(([tag, count]) => `
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-300 capitalize">${escapeHtml(tag)}</span>
                        <div class="flex items-center space-x-2 flex-1 ml-4">
                            <div class="flex-1 bg-gray-700 rounded-full h-2 overflow-hidden">
                                <div class="h-full clean-gradient rounded-full transition-all duration-300" 
                                     style="width: ${(count / maxCount) * 100}%"></div>
                            </div>
                            <span class="text-xs text-gray-400 min-w-[2rem]">${count}</span>
                        </div>
                    </div>
                `).join('');
            }
        }
        function populateArchetypeFilter() {
            const filter = document.getElementById('filterArchetype');
            const allTags = new Set();
            
            dreams.forEach(dream => {
                dream.tags?.forEach(tag => allTags.add(tag));
            });
            const sortedTags = Array.from(allTags).sort();
            filter.innerHTML = '<option value="">All Archetypes</option>' +
                sortedTags.map(tag => `<option value="${escapeHtml(tag)}">${escapeHtml(tag)}</option>`).join('');
        }
        function filterDreams() {
            const search = document.getElementById('searchDreams').value.toLowerCase();
            const archetype = document.getElementById('filterArchetype').value;
            
            const filtered = dreams.filter(dream => {
                const matchesSearch = !search || 
                    dream.title.toLowerCase().includes(search) || 
                    dream.description.toLowerCase().includes(search) ||
                    dream.tags?.some(tag => tag.toLowerCase().includes(search));
                
                const matchesArchetype = !archetype || dream.tags?.includes(archetype);
                
                return matchesSearch && matchesArchetype;
            });
            const gridContainer = document.getElementById('dreamsGrid');
            const timelineContainer = document.getElementById('dreamsTimeline');
            
            if (filtered.length === 0) {
                const emptyMessage = '<div class="col-span-full text-center text-gray-400 py-8">No dreams match your search criteria.</div>';
                gridContainer.innerHTML = emptyMessage;
                timelineContainer.innerHTML = emptyMessage;
            } else {
                gridContainer.innerHTML = filtered.map(dream => createDreamCard(dream)).join('');
                timelineContainer.innerHTML = filtered.map(dream => createTimelineItem(dream)).join('');
            }
        }
        async function handlePrivacyToggle() {
            if (!currentUser || !userProfile) return;
            const shareToggle = document.getElementById('shareToggle');
            const shouldShare = shareToggle.checked;
            try {
                const userRef = window.firestore.doc(db, 'users', currentUser.uid);
                await window.firestore.updateDoc(userRef, {
                    shareAnonymized: shouldShare
                });
                
                userProfile.shareAnonymized = shouldShare;
                showSuccessToast(shouldShare ? 'Data sharing enabled' : 'Data sharing disabled');
            } catch (error) {
                console.error('Error updating privacy setting:', error);
                shareToggle.checked = !shouldShare; // Revert on error
            }
        }
        // Utility functions
        function showError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            if (errorEl) {
                const messageEl = errorEl.querySelector('p');
                if (messageEl) messageEl.textContent = message;
                errorEl.classList.remove('hidden');
                setTimeout(() => errorEl.classList.add('hidden'), 5000);
            }
        }
        function showSuccessToast(message) {
            const toast = document.getElementById('successToast');
            const messageEl = document.getElementById('successMessage');
            messageEl.textContent = message;
            
            toast.classList.remove('translate-x-full', 'opacity-0');
            toast.classList.add('translate-x-0', 'opacity-100');
            
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                toast.classList.remove('translate-x-0', 'opacity-100');
            }, 3000);
        }
        function getAuthErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/email-already-in-use':
                    return 'This email is already registered. Try logging in instead.';
                case 'auth/weak-password':
                    return 'Password should be at least 6 characters long.';
                case 'auth/invalid-email':
                    return 'Please enter a valid email address.';
                case 'auth/user-not-found':
                    return 'No account found with this email address.';
                case 'auth/wrong-password':
                    return 'Incorrect password. Please try again.';
                case 'auth/too-many-requests':
                    return 'Too many failed attempts. Please try again later.';
                default:
                    return 'An error occurred. Please try again.';
            }
        }
    </script>
</body>
</html>